/*
	Copyright (c) 2015 Digital Airways (www.DigitalAirways.com)
	This work is free. You can redistribute it and/or modify it under the
	terms of the "Do What The Fuck You Want To" Public License, Version 2,
	as published by Sam Hocevar. 
	See http://www.wtfpl.net for more details.
*/

module.exports = function ( RED ) {
    "use strict";
    
    function timeFilterNode ( config ) {
        RED.nodes.createNode ( this, config );
        this.start = Number(config.start) < 10 ? "0"+config.start+":00" : config.start+":00";
        this.end   = Number(config.end) < 10 ? "0"+config.end+":00" : config.end+":00";
        this.days  = config.days;
        var node   = this;
        
        this.on('input', function(msg) {
            if(msg.start !== undefined && msg.start !== "") this.start = msg.start;
            if(msg.end !== undefined && msg.end !== "")     this.end = msg.end;
            
            var now      = new Date(),
                timezone = Number(RED.settings.functionGlobalContext.settings.timezone) || 0,
                hourUTC  = now.getHours()+timezone,
                hour     = hourUTC < 10 ? "0"+hourUTC : hourUTC,
                min      = now.getMinutes() < 10 ? "0"+now.getMinutes() : now.getMinutes(),
                HHmm     = hour+":"+min,
                dayNum   = String(now.getDay());
            
            if(HHmm > node.start && HHmm < node.end) {
                if(node.days.indexOf(dayNum) > -1){
                    node.send(msg);
                }
            }
        });
    }
    RED.nodes.registerType("timefilter", timeFilterNode);
}