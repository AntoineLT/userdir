<!--
	Copyright (c) 2015 Digital Airways (www.DigitalAirways.com)
	This work is free. You can redistribute it and/or modify it under the
	terms of the "Do What The Fuck You Want To" Public License, Version 2,
	as published by Sam Hocevar.
-->

<script type="text/x-red" data-template-name="timefilter">
    <div class="form-row">
        <label for="timefilter"><i class="fa fa-clock-o"></i> <span data-i18n="timefilter.filter"></span></label>
        <span id="timefilter">
            <span data-i18n="node-red:inject.between"></span> 
            <select id="node-input-start" class="node-input-times"></select>
            <span data-i18n="node-red:inject.and"></span> 
            <select id="node-input-end" class="node-input-times"></select>
            <div id="checkbox_days" class="node-input-days">
                <div style="display: inline-block; vertical-align: top;margin-right: 5px;" data-i18n="node-red:inject.on">on</div>
                <div style="display:inline-block;">
                    <div>
                        <label><input type='checkbox' checked value='1'/> <span data-i18n="node-red:inject.days.0"></span></label>
                        <label><input type='checkbox' checked value='2'/> <span data-i18n="node-red:inject.days.1"></span></label>
                        <label><input type='checkbox' checked value='3'/> <span data-i18n="node-red:inject.days.2"></span></label>
                    </div>
                    <div>
                        <label><input type='checkbox' checked value='4'/> <span data-i18n="node-red:inject.days.3"></span></label>
                        <label><input type='checkbox' checked value='5'/> <span data-i18n="node-red:inject.days.4"></span></label>
                        <label><input type='checkbox' checked value='6'/> <span data-i18n="node-red:inject.days.5"></span></label>
                    </div>
                    <div>
                        <label><input type='checkbox' checked value='0'/> <span data-i18n="node-red:inject.days.6"></span></label>
                    </div>
                </div>
            </div>
        </span>
    </div>
	<div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="timefilter.name"></span></label>
        <input type="text" id="node-input-name" " data-i18n="[placeholder]timefilter.name">
    </div>
</script>
<style>
    .node-input-days {
        padding-left: 110px;
    }
    .node-input-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: top;
        width: 100px;
    }
    .node-input-days input {
        width: auto;
    }
    .node-input-times {
        width: 90px;
    }
</style>
<script type="text/x-red" data-help-name="timefilter">
    <p>This node allows the user to continue the flow during the time period
    set in it.</p>
    <h3>Advanced</h3>
    <p>The start time can be set with <code>msg.start</code></p>
    <p>The end time can be set with <code>msg.end</code></p>
</script>
<script type="text/javascript">
	RED.nodes.registerType ( "timefilter", {
		category: "function",
		defaults: {
			name : {value: ""},
            start: {value: "0"},
            end: {value: "1"},
            days: {value: ["1", "2", "3", "4", "5", "6", "0"]}
		},
		color: "#E6E0F8",
		paletteLabel : "timefilter",
		inputs: 1,
		outputs: 1,
		icon: "timer.png",
		label: function() {
            return this.name || "timefilter";
        },
		labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            $(".node-input-times").each(function() {
                for (var i=0;i<24;i++) {
                    var l = (i<10?"0":"")+i+":00";
                    $(this).append($("<option></option>").val(i).text(l));
                }
            });
            
            $("#node-input-start option[value='"+this.start+"']").attr('selected', 'selected');
            $("#node-input-end option[value='"+this.end+"']").attr('selected', 'selected');
            
            $("#checkbox_days input[type=checkbox]").removeAttr("checked");
            this.days.forEach(function(v) {
                $("#checkbox_days [value=" + v + "]").prop("checked", true);
            });
            
            $("<option></option>").val(24).text("00:00").appendTo("#node-input-end");
            $("#node-input-start").change(function() {
                var start = Number($("#node-input-start option:selected").val());
                var end = Number($("#node-input-end option:selected").val());
                $("#node-input-end option").remove();
                for (var i=start+1;i<25;i++) {
                    var l = (i<10?"0":"")+i+":00";
                    if (i==24) l = "00:00";
                    var opt = $("<option></option>").val(i).text(l).appendTo("#node-input-end");
                    if (i === end) opt.attr("selected","selected");
                }
            });
        },
        oneditsave: function() {
            this.start = $("#node-input-start option:selected").val();
            this.end = $("#node-input-end option:selected").val();
            this.days = $('#checkbox_days  input[type=checkbox]:checked').map(function(_, el) {
                return $(el).val()
            }).get();
        }
	});
</script>
